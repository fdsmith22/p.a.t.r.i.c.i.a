#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Pre-push hook for Neurlyn
echo "ğŸš€ Running pre-push checks..."
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# Track if any checks fail
CHECKS_FAILED=0

# 1. Run full test suite
echo "ğŸ§ª Running full test suite..."
npm test -- --passWithNoTests
if [ $? -ne 0 ]; then
    echo "âŒ Tests failed!"
    CHECKS_FAILED=1
else
    echo "âœ… Tests passed"
fi

# 2. Check code formatting
echo ""
echo "ğŸ’… Checking code formatting..."
npm run format:check > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ Code formatting issues found!"
    echo "   Run 'npm run format' to fix"
    CHECKS_FAILED=1
else
    echo "âœ… Code formatting OK"
fi

# 3. Run linter
echo ""
echo "ğŸ§¹ Running ESLint..."
npm run lint > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ Linting errors found!"
    echo "   Run 'npm run lint:fix' to fix auto-fixable issues"
    CHECKS_FAILED=1
else
    echo "âœ… No linting errors"
fi

# 4. Type checking
echo ""
echo "ğŸ“ Running type checks..."
if [ -f "tsconfig.json" ]; then
    npm run typecheck > /dev/null 2>&1
    if [ $? -ne 0 ]; then
        echo "âŒ Type errors found!"
        CHECKS_FAILED=1
    else
        echo "âœ… Type checks passed"
    fi
else
    echo "â­ï¸  No TypeScript configuration found, skipping"
fi

# 5. Build test
echo ""
echo "ğŸ—ï¸  Testing build process..."
npm run build > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "âŒ Build failed!"
    echo "   Please fix build errors before pushing"
    CHECKS_FAILED=1
else
    echo "âœ… Build successful"
    # Clean up build artifacts
    rm -rf dist/
fi

# 6. Security audit
echo ""
echo "ğŸ”’ Running security audit..."
npm audit --audit-level=high > /dev/null 2>&1
AUDIT_EXIT=$?
if [ $AUDIT_EXIT -ne 0 ]; then
    echo "âš ï¸  Security vulnerabilities found!"
    echo "   Run 'npm audit' for details"
    # Don't fail on audit issues, just warn
else
    echo "âœ… No high severity vulnerabilities"
fi

# 7. Check for large files
echo ""
echo "ğŸ“¦ Checking for large files..."
LARGE_FILES=$(find . -type f -size +1M -not -path "./node_modules/*" -not -path "./.git/*" -not -path "./dist/*" -not -path "./coverage/*" 2>/dev/null)
if [ ! -z "$LARGE_FILES" ]; then
    echo "âš ï¸  Large files detected (>1MB):"
    echo "$LARGE_FILES" | while read file; do
        SIZE=$(du -h "$file" | cut -f1)
        echo "   - $file ($SIZE)"
    done
fi

# 8. Check branch protection
echo ""
echo "ğŸŒ¿ Checking branch..."
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
    echo "âš ï¸  Pushing directly to $CURRENT_BRANCH branch"
    echo "   Consider creating a feature branch instead"
fi

# 9. Validate CSS
echo ""
echo "ğŸ¨ Validating CSS files..."
CSS_ERRORS=0
for file in $(find styles -name "*.css" 2>/dev/null); do
    # Check for syntax errors (basic check)
    if ! grep -q "^}" "$file" && grep -q "{" "$file"; then
        echo "âš ï¸  Possible unclosed bracket in $file"
        CSS_ERRORS=1
    fi
done
if [ $CSS_ERRORS -eq 0 ]; then
    echo "âœ… CSS validation passed"
fi

# 10. Check commit messages
echo ""
echo "ğŸ“ Checking commit messages..."
COMMITS=$(git log origin/main..HEAD --format="%s" 2>/dev/null)
if [ ! -z "$COMMITS" ]; then
    INVALID_COMMITS=$(echo "$COMMITS" | grep -v "^[A-Z]" || true)
    if [ ! -z "$INVALID_COMMITS" ]; then
        echo "âš ï¸  Some commits don't start with capital letter:"
        echo "$INVALID_COMMITS" | head -3
    fi
fi

# Summary
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $CHECKS_FAILED -eq 0 ]; then
    echo "âœ… All pre-push checks passed!"
    echo "ğŸš€ Pushing to remote..."
else
    echo "âŒ Some checks failed!"
    echo ""
    read -p "Do you want to push anyway? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo "Push cancelled"
        exit 1
    fi
    echo "âš ï¸  Pushing with failures..."
fi